<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Регистрация | Кабинет Искателя</title>

    <link rel="icon" th:href="@{/images/icon/al_vadud_vector_title.svg}" type="image/svg"/>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Lobster&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Jost:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Orelega+One&display=swap" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/ionicons/2.0.1/css/ionicons.min.css"/>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <script defer th:src="@{/js/main.js}"></script>
    <script type="module" th:src="@{/js/header.js}"></script>
</head>

<body class="page-user-sign-up">
<div class="page-video">
    <video class="video" controls loop="loop" autoplay muted th:poster="@{/images/fly_on_clouds.jpg}">
        <source th:src="@{/video/fly_on_clouds.mp4}" type="video/mp4" />
        <source th:src="@{/video/fly_on_clouds.webm}" type="video/webm" />
    </video>
</div>

<header id="page-header" th:replace="~{../static/fragments/header :: header}"></header>

<div class="bg-image" id="body-bg-image"></div>

<main>

    <!-- Форма регистрации -->
    <div class="registration-container">
        <header>Регистрация</header>

        <form action="#">
            <div class="form first">
                <div class="details personal">
                    <header class="title">Персональные данные</header>

                    <div class="fields">
                        <div class="input-field">
                            <label>Имя пользователя</label>
                            <input
                                    type="text"
                                    placeholder="Введите имя пользователя"
                                    required
                            />
                        </div>

                        <div class="input-field">
                            <label>Пароль</label>
                            <input
                                    id="sign-up-password-input"
                                    type="password"
                                    placeholder="Введите пароль"
                                    required
                            />
                            <i class="fa fa-eye-slash fa-xs" id="sign-up-password"></i>
                        </div>

                        <div class="input-field">
                            <label>Email</label>
                            <input
                                    type="email"
                                    placeholder="Введите свой email"
                                    required
                            />
                        </div>

                        <div class="input-field">
                            <label>Имя</label>
                            <input type="text" placeholder="Введите своё имя" required />
                        </div>

                        <div class="input-field">
                            <label>Фамилия</label>
                            <input
                                    type="text"
                                    placeholder="Введите свою фамилию"
                                    required
                            />
                        </div>

                        <div class="input-field">
                            <label>Дата рождения</label>
                            <input
                                    type="date"
                                    placeholder="Введите свой день рождения"
                                    required
                            />
                        </div>

                        <div class="input-field">
                            <label>Номер телефона</label>
                            <span class="validity"></span>
                            <input
                                    id="phone-number"
                                    type="tel"
                                    placeholder="+380664988869"
                                    pattern="[0-9]{5}-[0-9]{2}-[0-9]{3}-[0-9]{2}"
                            />
                        </div>

                        <div class="input-field">
                            <label>Пол</label>
                            <select required>
                                <option disabled selected>Выберите свой пол</option>
                                <option>Мужской</option>
                                <option>Женский</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="details ID">
                    <header class="title">Дополнительный данные</header>

                    <div class="fields">
                        <div class="input-field">
                            <label>Аватар</label>
                            <input type="file" placeholder="Загрузите фото на аватар" />
                        </div>

                        <div class="input-field">
                            <label>Место нахождения</label>
                            <input
                                    id="resident-city"
                                    type="text"
                                    placeholder="Начните вводить город..."
                            />
                            <div id="suggestions" class="suggestions"></div>
                        </div>

                        <div class="input-field">
                            <label>Дата начала учёбы в Школе</label>
                            <input type="date" required />
                        </div>

                        <div class="input-field">
                            <label>Ваш куратор</label>
                            <select required>
                                <option disabled selected>Выберите своего куратора</option>
                                <option>Руслан Жуковец</option>
                                <option>Алексей Киселёв</option>
                                <option>Александр Циганков</option>
                            </select>
                        </div>
                    </div>

                    <button class="nextBtn" type="submit">
                        <span class="btnText">Зарегистрироваться</span>
                    </button>
                </div>
            </div>
        </form>
    </div>

    <footer id="page-footer" th:insert="~{../static/fragments/footer :: footer}"></footer>

</main>

<!-- Форма поиска по сайту -->
<div th:replace="~{../static/fragments/popups :: search-container}" class="search-container hide"></div>
<!-- Форма входа юзера -->
<div th:replace="~{../static/fragments/popups :: sign-in-container}" class="sign-in-container" id="sign-in-container"></div>
<!-- Форма информации про пользователя -->
<div th:replace="~{../static/fragments/popups :: user-information-container}" class="user-information-container" id="user-information-container"></div>
<!-- Форма уведомлений -->
<div th:replace="~{../static/fragments/popups :: notification-container}" class="notification-container"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/js/bootstrap.bundle.min.js"></script>
<script src="https://kit.fontawesome.com/d6a7640edd.js" crossorigin="anonymous"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {

      // --- Логика из initFragments.js (для хедера) ---

      // Эта часть кода нужна, если хедер будет загружен на страницу.
      // Thymeleaf вставит его статически, поэтому скрипты должны найти эти элементы.
      function initHeaderJS() {
          const userEmail = 'True_Finder@mystic-school.ru';
          const userPassword = 'incompleteness2025';

          const alVadudIcon = document.querySelector('.al-vadud');
          const shcoolName = document.querySelector('.school-name');
          if(alVadudIcon && shcoolName) {
              alVadudIcon.addEventListener('mouseenter', () => changeLogoColor(true));
              alVadudIcon.addEventListener('mouseleave', () => changeLogoColor(false));
              shcoolName.addEventListener('mouseenter', () => changeLogoColor(true));
              shcoolName.addEventListener('mouseleave', () => changeLogoColor(false));
          }

          function changeLogoColor(isFocuse) {
              if (isFocuse) {
                  shcoolName.style.color = 'gold';
                  alVadudIcon.style.fill = 'gold';
              } else {
                  shcoolName.style.color = 'red';
                  alVadudIcon.style.fill = 'red';
              }
          }

          const searchToggle = document.querySelector('.searchToggle');
          if(searchToggle) {
              searchToggle.addEventListener('click', () => {
                  searchToggle.classList.toggle('active');
              });
          }

          // ... (остальной код для хедера, если он будет на этой странице)
      }

      // --- Логика из main.js (для страницы регистрации) ---

      // Изменение видимости пароля в форме регистрации
      const signUpShowPassIcon = document.querySelector('#sign-up-show-password');
      const signUpHidePassIcon = document.querySelector('#sign-up-hide-password');
      const signUpInputPass = document.querySelector('#sign-up-pass');

      if (signUpShowPassIcon) {
          signUpShowPassIcon.addEventListener('click', () => {
              signUpInputPass.setAttribute('type', 'password');
              signUpShowPassIcon.style.display = 'none';
              signUpHidePassIcon.style.display = 'block';
          });
      }

      if (signUpHidePassIcon) {
          signUpHidePassIcon.addEventListener('click', () => {
              signUpInputPass.setAttribute('type', 'text');
              signUpShowPassIcon.style.display = 'block';
              signUpHidePassIcon.style.display = 'none';
          });
      }

      // АВТОЗАПОЛНЕНИЕ НАЗВАНИЯ ГОРОДА
      const input = document.getElementById('resident-city');
      const suggestionsContainer = document.getElementById('suggestions');
      const cache = new Map();
      let debounceTimeout;

      function debounce(func, delay) {
          return function (...args) {
              clearTimeout(debounceTimeout);
              debounceTimeout = setTimeout(() => func.apply(this, args), delay);
          };
      }

      function detectLanguage(query) {
          const cyrillicPattern = /[\u0400-\u04FF]/;
          return cyrillicPattern.test(query) ? 'ru' : 'en';
      }

      async function fetchCitySuggestions(query) {
          if (!query || query.length < 2) {
              suggestionsContainer.innerHTML = '';
              return;
          }
          const lang = detectLanguage(query);
          if (cache.has(query)) {
              displaySuggestions(cache.get(query));
              return;
          }
          try {
              const response = await fetch(
                  `https://nominatim.openstreetmap.org/search?format=geocodejson&q=${encodeURIComponent(query)}&addressdetails=1&limit=5&accept-language=${lang}`
              );
              const data = await response.json();
              const features = data.features || [];
              cache.set(query, features);
              displaySuggestions(features);
          } catch (error) {
              console.error('Ошибка при получении данных с Nominatim API:', error);
          }
      }

      function displaySuggestions(suggestions) {
          suggestionsContainer.innerHTML = '';
          if (suggestions.length === 0) {
              return;
          }
          const fragment = document.createDocumentFragment();
          suggestions.forEach(suggestion => {
              const cityName = suggestion.properties?.geocoding?.name || '';
              const country = suggestion.properties?.geocoding?.country || '';
              const displayName = suggestion.properties?.geocoding?.label || '';

              if (cityName && country) {
                  const suggestionItem = document.createElement('div');
                  suggestionItem.textContent = `${cityName}, ${country}`;
                  suggestionItem.addEventListener('click', () => {
                      input.value = displayName;
                      suggestionsContainer.innerHTML = '';
                  });
                  fragment.appendChild(suggestionItem);
              }
          });
          suggestionsContainer.appendChild(fragment);
      }

      if (input) {
          input.addEventListener('input', debounce(() => {
              const query = input.value.trim();
              fetchCitySuggestions(query);
          }, 300));

          document.addEventListener('click', e => {
              if (!e.target.closest('.input-field')) {
                  suggestionsContainer.innerHTML = '';
              }
          });
      }

      // Вызываем инициализацию JS для хедера
      initHeaderJS();
    });
</script>
</body>
</html>