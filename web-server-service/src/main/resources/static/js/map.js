import L,{extend,map,marker}from"leaflet";import{contentService}from"../contentItemsService.js";import{Modal,ModalImage}from"../modal.js";import{MapConstans}from"./mapConstans.js";export const mapServices=new Array;class BaseMapService{createMap(e){this.map=L.map(e,{zoomControl:!1,attributionControl:!1,keyboard:!1}).setView([51.487889,31.303815],13);const t=L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png");t.addTo(this.map);const o={Карта:t,Спутник:L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}")};L.control.zoom({position:"topright"}).addTo(this.map),L.control.layers(o,null,{position:"topright",collapsed:!0}).addTo(this.map)}populateMap(){const e=this.map,t=this.routesService.routes,o=this.markersService.routeMarkers;for(let o in t)t[o].shape.addTo(e);for(let t in o){const n=o[t];console.log("markers: ",n),n.forEach((t=>t.addTo(e)))}this.fitMapToVisibleRoutes()}async createMapControls(){const e=this,t=this.routesService,o=this.markersService.markerStyles,n=await this.getMoskowSvgElement(),r=await this.getTverSvgElement();switch(this.mapType){case"routes-map":const a=L.Control.extend({onAdd:function(o){const n=L.DomUtil.create("div","leaflet-bar leaflet-control leaflet-route-control collapsed"),r=document.createElement("div"),a=document.createElement("div"),i=document.createElement("i");r.className="leaflet-control-title-container leaflet-route-control-title-container",a.className="leaflet-control-title leaflet-route-control-title",a.innerText="Маршруты:",i.className="bx control-title-chevron bx-chevron-down",r.appendChild(a),r.appendChild(i),n.appendChild(r);const s=document.createElement("div");s.className="leaflet-groups leaflet-route-groups";const c=t.groupeRoutesByCity();for(const[o,n]of Object.entries(c)){const r=document.createElement("div");r.className="leaflet-group leaflet-route-group";const a=document.createElement("div");a.className="leaflet-group-title leaflet-route-group-title",a.innerText=o,r.appendChild(a),n.forEach((({routeId:o,route:n})=>{const a=n.routedata,i=document.createElement("label"),s=document.createElement("input"),c=document.createElement("div"),l=n.shapeStyles.defaultStyle,p=document.createElement("span");s.type="checkbox",s.checked=!0,s.dataset.routeId=o,s.addEventListener("change",(function(){const o=this.dataset.routeId;t.routes[o],this.checked,e.showOrHideRoute(o)})),i.className="leaflet-route-label",i.appendChild(s),c.classList.add("leaflet-route-symbol"),c.style.borderTop=`${l.weight}px ${l?"dashed":"solid"} ${l.color}`,c.style.opacity=l.opacity,p.textContent=" "+a.routeName,i.appendChild(c),i.appendChild(p),r.appendChild(i)})),s.appendChild(r)}return n.appendChild(s),L.DomEvent.disableClickPropagation(n),n}});this.map.addControl(new a({position:"topright",collapsed:!0}));case"one-route-map":const i=L.Control.extend({onAdd:function(e){const t=L.DomUtil.create("div","leaflet-bar leaflet-control leaflet-symbols-control collapsed"),n=document.createElement("div"),r=document.createElement("div"),a=document.createElement("i");n.className="leaflet-control-title-container leaflet-symbols-control-title-container",r.className="leaflet-control-title leaflet-symbols-control-title",r.innerText="Условные обозначения:",a.className="bx control-title-chevron bx-chevron-down",n.appendChild(r),n.appendChild(a),t.appendChild(n);const i=document.createElement("div");i.className="leaflet-groups leaflet-symbols-groups";const s=document.createElement("div");s.className="leaflet-group leaflet-symbol-group";const c=document.createElement("div");return c.className="leaflet-group-title leaflet-symbol-group-title",c.innerText="Маркеры точек",s.appendChild(c),Object.entries(o).forEach((([e,t])=>{const o=t.options,n=document.createElement("div");let r=o.html;r=r.replace("icon-layer","icon-layer no-hover");const a=document.createElement("p");a.textContent=" - "+o.description,n.className="leaflet-symbol-label",n.innerHTML=r,n.appendChild(a),s.appendChild(n)})),i.appendChild(s),t.appendChild(i),L.DomEvent.disableClickPropagation(t),t}});this.map.addControl(new i({position:"topleft",collapsed:!0}));default:const s=L.Control.extend({onAdd:function(t){const o=L.DomUtil.create("div","leaflet-bar leaflet-control leaflet-container-fit-size-control");"one-route-map"===e.mapType&&o.classList.add("one-route-map");const a=document.createElement("i"),i=document.createElement("i"),s=document.createElement("i");return s.className="fa-solid fa-map-location-dot",s.setAttribute("title","Показать выбранную точку"),i.className="bx bx-shape-polygon",i.setAttribute("title","Показать выделенный маршрут"),a.className="bx bx-fullscreen",a.setAttribute("id","map-fullscreen-control-icon"),a.setAttribute("title","Во весь экран"),o.appendChild(s),"routes-map"===e.mapType&&(o.appendChild(n),o.appendChild(r)),o.appendChild(i),o.appendChild(a),L.DomEvent.disableClickPropagation(o),o}});this.map.addControl(new s({position:"bottomright"}));const c=L.Control.extend({onAdd:function(e){const t=L.DomUtil.create("div","leaflet-bar leaflet-control leaflet-container-external-maps-control"),o=document.createElement("i"),n=document.createElement("i");return o.className="fa-brands fa-google",o.setAttribute("title","Открыть в Google Maps"),n.className="fa-brands fa-yandex-international",n.setAttribute("title","Открыть в Яндекс Карты"),t.appendChild(o),t.appendChild(n),L.DomEvent.disableClickPropagation(t),t}});this.map.addControl(new c({position:"bottomright"}))}}createMapListeners(){const e=this;if(this.routesService){console.log("Создание лисенеров");const t=e.map.getContainer(),o=e.routesService,n=e.routesService.routes,r=e.markersService,a=r.routeMarkers;let i=!1;const s=t.querySelector(".leaflet-control-container"),c=document.getElementById("map-fullscreen-wrapper");this.map.on("click",(t=>{const n=this.markersService.currentMarker;i?i=!1:(console.log("Клик по пустому месту карты"),null!=o.currentRoute&&e.deselectRoute(),null!=n&&e.deselectMarker())}));for(const[t,r]of Object.entries(n))r.shape.on("click",(n=>{i=!0,n.originalEvent.preventDefault(),n.originalEvent.target.blur(),document.activeElement.blur(),o.currentRoute!==r?(e.deselectRoute(),e.selectRoute(t)):this.deselectRoute(),this.zoomToRoute(t)}));for(const[t,o]of Object.entries(a))o.forEach((t=>{t.on("click",(function(){e.selectMarker(t)})),t.once("popupopen",(()=>{setTimeout((()=>{e.toggleActiveSwitchMapMarkersIcons()}),500)}))}));console.log("Control container: ",s),s.addEventListener("click",(t=>{const n=t.target;if(console.log("Map listeners"),console.log("target",n),n.classList.contains("bx-chevron-down")||n.classList.contains("bx-chevron-up")){const e=n.closest(".leaflet-control"),t=n;e.classList.toggle("collapsed"),t.classList.contains("bx-chevron-down")?(t.classList.remove("bx-chevron-down"),t.classList.add("bx-chevron-up")):(t.classList.remove("bx-chevron-up"),t.classList.add("bx-chevron-down"))}if((n.classList.contains("bx-fullscreen")||n.classList.contains("bx-exit-fullscreen"))&&(n.classList.contains("bx-fullscreen")?(this.MoveMap(),n.classList.remove("bx-fullscreen"),n.classList.add("bx-exit-fullscreen"),n.setAttribute("title","Выход из полноэкранного режима")):(this.MoveMap(),n.classList.remove("bx-exit-fullscreen"),n.classList.add("bx-fullscreen"),n.setAttribute("title","Во весь экран"))),null!=n.closest(".moskow-arm-svg-wrapper")){const e="г. Москва";this.fitMapToCityRoutes(e)}n.classList.contains("bx-shape-polygon")&&this.fitMapToSelectedRoute(),n.classList.contains("fa-map-location-dot")&&this.fitMapToSelectedMarker();let a,i=o.currentRoute,s=r.currentMarker;if(console.log("route",i),console.log("marker",s),n.classList.contains("fa-google")){if(null==s&&null==i)return void e.showExternalMapWarnWindow(a,3e3,!0);if(null!=i&&i.routedata.points.length>2){let e="https://www.google.com/maps/dir/?api=1";const t=i.routedata.points;e+=`&origin=${t[0].coordinates.join(",")}&destination=${t[t.length-1].coordinates.join(",")}&waypoints=${t.slice(1,t.length-1).filter((e=>"between"!==e.role)).map((e=>e.coordinates.join(","))).join("|")}&travelmode=walking`,window.open(e,"_blank")}else if(null!=s){const e=s._latlng.lat,t=s._latlng.lng,o=`https://www.google.com/maps/place/${e},${t}/@${e},${t},19z`;window.open(o,"_blank")}}if(n.classList.contains("fa-yandex-international")){if(null==s&&null==i)return void e.showExternalMapWarnWindow(a,3e3,!1);if(null!=i&&i.routedata.points.length>2){const e=i.routedata.points,t=e[0].coordinates.join(","),o=e[e.length-1].coordinates.join(","),n=e.slice(1,e.length-1).filter((e=>"between"!==e.role)).map((e=>e.coordinates.join(",")));let r=t;n.length>0&&(r+="~"+n.join("~")),r+="~"+o;const a=`https://yandex.ru/maps/?rtext=${r}&rtt=pedestrian&z=19`;window.open(a,"_blank")}else if(null!=s){const e=s._latlng.lat,t=s._latlng.lng,o=`https://yandex.ru/maps/?ll=${t},${e}&z=19&pt=${t},${e},pm2grml`;window.open(o,"_blank")}}})),c.addEventListener("click",(e=>{if("map-fullscreen-exit"===e.target.getAttribute("id")){const e=document.getElementById("map-fullscreen-control-icon");e.classList.remove("bx-exit-fullscreen"),e.classList.add("bx-fullscreen"),e.setAttribute("title","Во весь экран"),this.MoveMap()}})),t.addEventListener("click",(t=>{const o=t.target;if(o.classList.contains("popup-close-icon")&&e.deselectMarker(),o.classList.contains("route-popup-close-icon")&&e.deselectRoute(),o.classList.contains("popup-multimedia-item")){const t=o.closest(".popup-multimedia-container").querySelectorAll(".photo-container");t.forEach((e=>{e.classList.remove("active")})),o.closest(".photo-container").classList.add("active"),this.modalImage.open(e.getCloneHtmlElements(t))}o.classList.contains("fit-point-on-map-icon")&&e.fitMapToSelectedMarker(),o.classList.contains("current-route-info-icon")&&(e.toggleActivePointPopupContentContainer("current-route-info-icon"),e.toggleActivePopupIcon("current-route-info-icon")),o.classList.contains("point-description-icon")&&(e.toggleActivePointPopupContentContainer("point-description-icon"),e.toggleActivePopupIcon("point-description-icon")),o.classList.contains("point-images-icon")&&(e.toggleActivePointPopupContentContainer("point-images-icon"),e.toggleActivePopupIcon("point-images-icon")),o.classList.contains("point-media-files-icon")&&(e.toggleActivePointPopupContentContainer("point-media-files-icon"),e.toggleActivePopupIcon("point-media-files-icon")),o.classList.contains("point-add-media-comment-icon")&&(e.toggleActivePointPopupContentContainer("point-add-media-comment-icon"),e.toggleActivePopupIcon("point-add-media-comment-icon")),o.classList.contains("point-write-comment-icon")&&(e.toggleActivePointPopupContentContainer("point-write-comment-icon"),e.toggleActivePopupIcon("point-write-comment-icon")),o.classList.contains("next-point-icon")&&e.toggleActiveMarker(o.classList),o.classList.contains("prev-point-icon")&&e.toggleActiveMarker(o.classList)}))}}getContainerId(){return this.map.getContainer().id}zoomToRoute(e){const t=this.routesService[e];t&&this.map.flyToBounds(t.getBounds(),{padding:[30,30],duration:2,easeLinearity:.25,maxZoom:14})}fitMapToVisibleRoutes(){const e=new L.LatLngBounds;let t=!1;for(const o of Object.values(this.routesService.routes))this.map.hasLayer(o.shape)&&(e.extend(o.shape.getBounds()),t=!0);t&&this.map.fitBounds(e,{padding:[20,20],maxZoom:14})}fitMapToCityRoutes(e){const t=this.routesService.groupeRoutesByCity(),o=new L.LatLngBounds;for(const[n,r]of Object.entries(t))n===e&&r.forEach((({routeId:e,route:t})=>{o.extend(t.shape.getBounds())}));o.isValid()&&this.map.fitBounds(o,{padding:[20,20],maxZoom:14})}fitMapToSelectedRoute(){const e=this.routesService.currentRoute;if(null===e)return;const t=e.shape.getBounds();this.map.fitBounds(t,{padding:[20,20],maxZoom:17})}fitMapToSelectedMarker(){const e=this.markersService.currentMarker;if(!e)return;const t=e.getLatLng();this.map.setView(t,18)}MoveMap(){const e=this.originalMapWrapper,t=this.map.getContainer(),o=document.getElementById("map-fullscreen-wrapper"),n=document.getElementById("map-fullscreen-container");if(e.classList.contains("content-map-wrapper")){e.removeChild(t),e.classList.remove("content-map-wrapper"),o.classList.add("show"),n.classList.add("content-map-wrapper"),n.appendChild(t),clearTimeout(r);const r=setTimeout((()=>{this.fitMapToVisibleRoutes(),this.map.invalidateSize()}),300)}else{n.removeChild(t),o.classList.remove("show"),n.classList.remove("content-map-wrapper"),e.classList.add("content-map-wrapper"),e.appendChild(t),clearTimeout(r);const r=setTimeout((()=>{this.fitMapToVisibleRoutes(),this.map.invalidateSize()}),300)}}selectRoute(e){if(null===e)return;const t=this.routesService,o=t.routes[e].shape;t.selectRoute(e),o.openPopup(),this.toggleSelectingRowInActiveContentFormat(e)}deselectRoute(){const e=this.routesService;if(null==e.currentRoute)return;const t=e.currentRoute.shape;console.log("routeId: ",e.currentRoute.routedata.routeId),this.toggleSelectingRowInActiveContentFormat(e.currentRoute.routedata.routeId),e.deselectRoute(),t.closePopup()}showOrHideRoute(e){const t=this.map,o=this.routesService.routes[e];o.visible?(t.removeLayer(o.shape),o.visible=!1,this.showOrHideMarkers(o.markers,!1)):(o.shape.addTo(this.map),o.visible=!0,this.showOrHideMarkers(o.markers,!0))}selectMarker(e){null!==e&&(this.markersService.selectMarker(e),e.openPopup(),this.toggleActiveSwitchMapMarkersIcons())}deselectMarker(){const e=this.markersService;null!=e.currentMarker&&(e.currentMarker.closePopup(),e.deselectMarker())}showOrHideMarkers(e,t){const o=this.map;t?e.forEach((e=>e.addTo(o))):e.forEach((e=>o.removeLayer(e)))}toggleSelectingRowInActiveContentFormat(e){const t=this.contentItemsService.activeContentItem.item.querySelector(`i[route-id="${e}"]`);this.contentItemsService.toggleSelectedContentItemDataRow(t)}showExternalMapWarnWindow(e,t,o){const n=document.querySelector(".leaflet-container-external-maps-control");let r;r=o?document.querySelector(".google-maps-warning-window"):document.querySelector(".yandex-maps-warning-window");const a=n.getBoundingClientRect().top,i=n.getBoundingClientRect().left-r.getBoundingClientRect().width;r.style.top=a+"px",r.style.left=i-10+"px",r.classList.add("active"),clearTimeout(e),e=setTimeout((()=>{r.classList.remove("active")}),t)}toggleActiveMarker(e){const t=this.markersService;let o;e.contains("next-point-icon")?o=t.nextMarker:e.contains("prev-point-icon")&&(o=t.prevMarker),t.currentMarker.closePopup(),t.selectMarker(o),this.fitMapToSelectedMarker(),t.currentMarker.openPopup()}toggleActiveSwitchMapMarkersIcons(){const e=this.map.getContainer(),t=this.markersService,o=e.querySelector(".prev-point-icon"),n=e.querySelector(".next-point-icon");null===t.prevMarker?o.classList.remove("active"):o.classList.add("active"),null===t.nextMarker?n.classList.remove("active"):n.classList.add("active")}toggleActivePointPopupContentContainer(e){const t=this.getPopupContentId(e),o=document.getElementById(t);null!=o&&(this.deactivatePopupContentContainer(),o.classList.add("show"))}deactivatePopupContentContainer(){const e=this.getPopupContentId(this.markersService.currentMarker.options.activeIcon),t=document.getElementById(e);null!=t&&t.classList.remove("show")}toggleActivePopupIcon(e){const t=this.map.getContainer(),o=this.markersService.currentMarker.options.activeIcon,n=t.querySelector(`.${e}`),r=t.querySelector(`.${o}`);r!==n&&(null!=r&&r.classList.remove("selected"),null!=n&&(this.markersService.currentMarker.options.activeIcon=e,n.classList.add("selected")))}getPopupContentId(e){return e.substring(0,e.indexOf("-icon"))}setPopupForShape(){const e=this.routesService.routes;for(const[t,o]of Object.entries(e)){const e=o.shape;e.bindPopup(this.getShapePopupElement(o.routedata));const t=this.getShapeToolTipElement(o.routedata);e.bindTooltip(t,{permanent:!1,direction:"top",offset:[0,0],className:"shape-tooltip-wrapper"})}}setTooltipToShape(){const e=this.routesService.routes;for(const[t,o]of Object.entries(e)){const e=o.shape,t=this.getShapeToolTipElement(o.routedata);e.bindTooltip(t,{permanent:!1,direction:"top",offset:[0,0],className:"shape-tooltip-wrapper"})}}setPopupForMarkers(){const e=this.markersService.routeMarkers;for(const[t,o]of Object.entries(e))o.forEach((e=>{const t=e.options.markerData;let o;o="between"===t.role||"between-multimedia"===t.role?this.getBetweenPointPopupElement(e):this.getPointPopupElement(e),e.bindPopup(o,{offset:[-280,0]})}))}setTooltipForMarkers(){const e=this.markersService.routeMarkers;for(const[t,o]of Object.entries(e))o.forEach((e=>{const t=this.getPointToolTipElement(e);e.bindTooltip(t,{permanent:!1,direction:"top",offset:[5,-30],className:"point-tooltip-wrapper"})}))}async getMoskowSvgElement(){const e=document.createElement("div");e.classList.add("moskow-arm-svg-wrapper"),e.setAttribute("title","Показать все маршруты Москвы");try{const t=await fetch("./images/icon/Moskow_arm.svg"),o=await t.text();return e.innerHTML=o,e}catch(e){console.log(`Ошибка загрузки Moskow-arm.svg: ${e}`)}}async getTverSvgElement(){const e=document.createElement("div");e.classList.add("tver-arm-svg-wrapper"),e.setAttribute("title","Показать все маршруты Твери");try{const t=await fetch("./images/icon/Tver_arm.svg"),o=await t.text();return e.innerHTML=o,e}catch(e){console.log(`Ошибка загрузки Tver_arm.svg: ${e}`)}}getShapePopupElement(e){const t=document.createElement("div"),o=document.createElement("div"),n=document.createElement("i"),r=document.createElement("h4"),a=document.createElement("div"),i=document.createElement("div");return t.classList.add("map-popup-wrapper"),o.classList.add("map-popup-container","show"),o.setAttribute("id","route-description"),n.classList.add("route-popup-close-icon","bx","bx-x"),r.classList.add("route-name"),r.innerHTML=e.routeName,a.classList.add("route-description-container"),a.innerHTML=e.routeDescription,i.classList.add("route-brief-description-container"),i.innerHTML=e.routeBriefDescription,o.appendChild(r),o.appendChild(a),o.appendChild(i),t.appendChild(n),t.appendChild(o),t}getShapeToolTipElement(e){const t=document.createElement("div"),o=document.createElement("h3"),n=document.createElement("p");return t.classList.add("shape-tooltip-container"),o.classList.add("route-name"),o.innerHTML=`Маршрут: ${e.routeName}`,n.classList.add("route-additional-info"),n.innerHTML="Для получения более полной информации нажмите на маршрут",t.appendChild(o),t.appendChild(n),t}getPointPopupElement(e){const t=document.createElement("div"),o=document.createElement("i"),n=this.getPointPopupIconsHtmlContainer(),r=this.getPointPopupDescriptionHtmlElement(e),a=this.getPointPopupCurrentRouteInfoHtmlElement(e),i=this.getPointImagesHtmlElement(e),s=this.getPointMediaFilesHtmlElement(e),c=this.getPointWriteCommentHtmlElement(),l=this.getPointAddImageHtmlElement();return t.classList.add("map-popup-wrapper"),t.setAttribute("point-type","point"),o.classList.add("popup-close-icon","bx","bx-x"),t.appendChild(o),t.appendChild(r),t.appendChild(a),t.appendChild(s),t.appendChild(i),t.appendChild(c),t.appendChild(l),t.appendChild(n),t}getPointPopupIconsHtmlContainer(){const e=document.createElement("div"),t=document.createElement("i"),o=document.createElement("i"),n=document.createElement("i"),r=document.createElement("i"),a=document.createElement("i"),i=document.createElement("i"),s=document.createElement("i"),c=document.createElement("div"),l=document.createElement("i"),p=document.createElement("i");return e.classList.add("icons-container"),t.classList.add("current-route-info-icon","fa-solid","fa-house-flag"),t.setAttribute("title","Описание маршрута"),o.classList.add("fit-point-on-map-icon","bx","bx-map-pin"),o.setAttribute("title","Показать выбранную точку на карте"),n.classList.add("point-description-icon","fa-solid","fa-file-pen","selected"),n.setAttribute("title","Описание выбранной точки"),r.classList.add("point-media-files-icon","bx","bx-headphone"),r.setAttribute("title","Аудио к выбранной точке"),a.classList.add("point-images-icon","bx","bxs-file-image"),a.setAttribute("title","Изображения к выбранной точке"),i.classList.add("point-write-comment-icon","bx","bx-comment-add"),i.setAttribute("title","Написать комментарии"),s.classList.add("point-add-media-comment-icon","bx","bx-image-add"),s.setAttribute("title","Добавить медиафайлы"),c.classList.add("chevrons-container"),p.classList.add("prev-point-icon","bx","bx-chevron-left"),p.setAttribute("title","Предыдущая точка маршрута"),l.classList.add("next-point-icon","bx","bx-chevron-right"),l.setAttribute("title","Следующая точка маршрута"),c.appendChild(p),c.appendChild(l),e.appendChild(t),e.appendChild(o),e.appendChild(n),e.appendChild(r),e.appendChild(a),e.appendChild(i),e.appendChild(s),e.appendChild(c),e}getPointPopupDescriptionHtmlElement(e){const t=e.options.markerData,o=this.routesService.routes[t.routeId].routedata,n=document.createElement("div"),r=document.createElement("h4"),a=document.createElement("h3"),i=document.createElement("p"),s=document.createElement("p"),c=document.createElement("p");return n.classList.add("map-popup-container","show"),n.setAttribute("id","point-description"),r.classList.add("route-name"),r.innerHTML=o.routeName,a.classList.add("point-name"),a.innerHTML=t.name,i.classList.add("point-key"),i.innerHTML=t.key,s.classList.add("route-comment"),s.innerHTML=o.routeComment,c.classList.add("point-address"),c.innerHTML=`<b>Адрес</b>: ${t.address}`,n.appendChild(r),n.appendChild(a),n.appendChild(i),n.appendChild(s),n.appendChild(c),n}getPointPopupCurrentRouteInfoHtmlElement(e){const t=e.options.markerData,o=this.routesService.routes[t.routeId].routedata,n=document.createElement("div"),r=document.createElement("h4"),a=document.createElement("p");return n.classList.add("map-popup-cnt-container"),n.setAttribute("id","current-route-info"),r.classList.add("content-title"),r.innerHTML="Описание маршрута",a.classList.add("content-description"),a.innerHTML=o.routeDescription,n.appendChild(r),n.appendChild(a),n}getPointImagesHtmlElement(e){const t=e.options.markerData,o=t.photoPaths,n=document.createElement("div"),r=document.createElement("h4"),a=this.getMultimediaHtmlContainer(t,o);return n.classList.add("map-popup-cnt-container"),n.setAttribute("id","point-images"),r.classList.add("content-title"),r.innerHTML="Изображения",n.appendChild(r),n.appendChild(a),n}getMultimediaHtmlContainer(e,t){const o=document.createElement("div"),n=document.createElement("h4");return o.classList.add("popup-multimedia-container","point-multimedia-container"),null!=t&&t.length>0?t.forEach((n=>{const r=document.createElement("div"),a=document.createElement("img"),i=document.createElement("h5");r.classList.add("photo-container"),e.photoDescriptions[t.indexOf(n)]&&(i.classList.add("photo-title"),i.innerHTML=e.photoDescriptions[t.indexOf(n)],r.appendChild(i)),a.src=n,a.classList.add("popup-multimedia-item"),r.appendChild(a),o.appendChild(r)})):(n.classList.add("no-images-title","no-content-title"),n.innerHTML="К данной точке изображений нет",o.appendChild(n)),o}getPointMediaFilesHtmlElement(e){const t=e.options.markerData,o=(this.routesService.routes[t.routeId].routedata,document.createElement("div")),n=document.createElement("h4"),r=document.createElement("h4");return o.classList.add("map-popup-cnt-container"),o.setAttribute("id","point-media-files"),n.classList.add("content-title"),n.innerHTML="Медиафайлы",r.classList.add("no-media-files-title","no-content-title"),r.innerHTML="К данной точке медиафайлов нет",o.appendChild(n),o.appendChild(r),o}getPointWriteCommentHtmlElement(){const e=document.createElement("div"),t=document.createElement("form"),o=document.createElement("h4"),n=document.createElement("textarea"),r=document.createElement("button");return e.classList.add("map-popup-cnt-container"),e.setAttribute("id","point-write-comment"),t.classList.add("map-popup-form"),o.classList.add("content-title"),o.innerHTML="Написать комментарий к точке маршрута",n.setAttribute("type","text"),n.setAttribute("placeholder","Введите комментарии"),r.classList.add("map-popup-control-button","btn"),r.setAttribute("type","button"),r.innerHTML="Сохранить",t.appendChild(o),t.appendChild(n),t.appendChild(r),e.appendChild(t),e}getPointAddImageHtmlElement(){const e=document.createElement("div"),t=document.createElement("form"),o=document.createElement("h4"),n=document.createElement("input"),r=document.createElement("button");return e.classList.add("map-popup-cnt-container"),e.setAttribute("id","point-add-media-comment"),t.classList.add("map-popup-form"),o.classList.add("content-title"),o.innerHTML="Добавить медиафайл",n.setAttribute("type","file"),n.setAttribute("placeholder","Выбирете файл для загрузки"),r.classList.add("map-popup-control-button","btn"),r.setAttribute("type","button"),r.innerHTML="Загрузить",t.appendChild(o),t.appendChild(n),t.appendChild(r),e.appendChild(t),e}isPopupOpen(){const e=this.map.getContainer().querySelector(".map-popup-container");return console.log("popupContainer",e),null!=e}getBetweenPointPopupElement(e){const t=e.options.markerData,o=t.photoPaths,n=this.routesService.routes[t.routeId].routedata,r=document.createElement("div"),a=document.createElement("div"),i=document.createElement("div"),s=document.createElement("i"),c=document.createElement("h4"),l=document.createElement("h3"),p=this.getMultimediaHtmlContainer(t,o),d=this.getBetweenPointPopupIconsHtmlContainer();return r.classList.add("map-popup-wrapper"),r.setAttribute("point-type","between"),a.classList.add("map-popup-container","show"),i.classList.add("map-popup-default-info-container","show"),s.classList.add("popup-close-icon","bx","bx-x"),c.classList.add("route-name"),c.innerHTML=n.routeName,l.classList.add("point-name"),l.innerHTML=t.name,a.appendChild(s),i.appendChild(c),i.appendChild(l),i.appendChild(p),a.appendChild(i),r.appendChild(a),r.appendChild(d),r}getBetweenPointPopupIconsHtmlContainer(){const e=document.createElement("div"),t=document.createElement("i"),o=document.createElement("div"),n=document.createElement("i"),r=document.createElement("i");return e.classList.add("icons-container"),t.classList.add("fit-point-on-map-icon","bx","bx-map-pin"),t.setAttribute("title","Показать выбранную точку на карте"),o.classList.add("chevrons-container"),n.classList.add("next-point-icon","bx","bx-chevron-right"),n.setAttribute("title","Следующая точка маршрута"),r.classList.add("prev-point-icon","bx","bx-chevron-left"),r.setAttribute("title","Предыдущая точка маршрута"),o.appendChild(r),o.appendChild(n),e.appendChild(t),e.appendChild(o),e}getPointToolTipElement(e){const t=e.options.markerData,o=document.createElement("div"),n=document.createElement("h3"),r=document.createElement("p");return o.classList.add("point-tooltip-container"),n.classList.add("point-name"),n.innerHTML=t.name,r.classList.add("point-additional-info"),r.innerHTML="Для получения более полной информации нажмите на маркер точки",o.appendChild(n),o.appendChild(r),o}getCloneHtmlElements(e){return Array.from(e,(e=>e.cloneNode(!0)))}}export class RoutesMapService extends BaseMapService{originalMapWrapper;map;mapType;routesService;markersService;contentItemsService;modal;modalImage;async create(e,t){super.createMap(e),this.mapType="routes-map";const o=new RouteService;await o.loadRoutes(t),this.routesService=o,this.markersService=this.routesService.markersService,super.populateMap(),this.addRouteDataToContentContainers(),super.setPopupForShape(),super.setTooltipToShape(),super.setPopupForMarkers(),super.setTooltipForMarkers(),this.originalMapWrapper=this.map.getContainer().parentElement;const n=document.getElementById(e).closest(".sb-cnt").id;this.contentItemsService=contentService.getContentItemsService(n),this.modal=new Modal,this.modalImage=new ModalImage,super.createMapListeners(),super.createMapControls()}get map(){return this.map}getMapContentConteinerId(){return this.map.getContainer().closest(".sb-cnt").id}getRoute(e){return this.routesService.routes[e]}getRouteData(e){return this.routesService.routes[e].routedata}isContainsRoute(e){return!!Object.keys(this.routesService.routes).includes(e)}addRouteDataToContentContainers(){const e=this.routesService.routes,t=document.getElementById("pilgrimage-tbl"),o=t.querySelectorAll(".tbl-body-row"),n=document.getElementById("pilgrimage-title"),r=n.querySelectorAll(".sb-cnt-title-container-item");for(const[a,i]of Object.entries(e)){const e=i.routedata,a=o[0],s=a.querySelectorAll(".tbl-row-data");if(""===s[0].textContent)s[0].innerHTML=e.routeName,s[1].innerHTML=e.routeBriefDescription,a.querySelector(".bx-map-pin").setAttribute("route-id",e.routeId);else{const n=a.cloneNode(!0);n.setAttribute("obj-id",o.length+1);const r=n.querySelectorAll(".tbl-row-data");r[0].innerHTML=e.routeName,r[1].innerHTML=e.routeBriefDescription,n.querySelector(".bx-map-pin").setAttribute("route-id",e.routeId),t.querySelector("tbody").appendChild(n)}const c=r[0],l=c.querySelectorAll(".title-data");if(""===l[0].textContent)l[0].innerHTML=e.routeName,l[1].innerHTML=e.routeBriefDescription,c.querySelector(".bx-map-pin").setAttribute("route-id",e.routeId);else{const t=c.cloneNode(!0);t.setAttribute("obj-id",r.length+1);const o=t.querySelectorAll(".title-data");o[0].innerHTML=e.routeName,o[1].innerHTML=e.routeBriefDescription,t.querySelector(".bx-map-pin").setAttribute("route-id",e.routeId),t.setAttribute("obj-id",r.length+1);const a=n.lastElementChild;n.insertBefore(t,a)}}}}export class OneRouteMapService extends BaseMapService{originalMapWrapper;map;mapType;routesService;markersService;contentItemsService;modal;modalImage;create(e,t){super.createMap(e),this.mapType="one-route-map";const o=new RouteService;o.init(t),this.routesService=o,this.markersService=o.markersService,super.populateMap(),super.setPopupForShape(),super.setTooltipToShape(),super.setPopupForMarkers(),super.setTooltipForMarkers(),this.originalMapWrapper=this.map.getContainer().parentElement;const n=document.getElementById(e).closest(".sb-cnt").id;this.contentItemsService=contentService.getContentItemsService(n),this.modal=new Modal,this.modalImage=new ModalImage,super.createMapListeners(),super.createMapControls()}getMap(){return this.map}getMapContentConteinerId(){return this.map.getContainer().closest(".sb-cnt").id}getRouteId(){return this.routesService.routes[0].routedata.routeId}}function handleMapNavigation(e,t){t.forEach((t=>{const o=t.map.getContainer(),n=(t.mapRoutes,o.querySelector(".next-point-icon")),r=o.querySelector(".prev-point-icon");if("ArrowRight"===e.key)t.isPopupOpen()&&!t.modalImage.isModalOpen()&&(e.preventDefault(),e.stopPropagation(),t.toggleActiveMarker(n.classList));else if("ArrowLeft"===e.key)t.isPopupOpen()&&!t.modalImage.isModalOpen()&&(e.preventDefault(),e.stopPropagation(),t.toggleActiveMarker(r.classList));else if("Escape"===e.key){const e=document.getElementById("map-photo-modal-wrapper");if(null!=e&&e.classList.contains("show"))return void t.modalImage.closePhotoModal()}}))}class RouteService{routes;currentRoute;shapeStyles;markersService;async loadRoutes(e){const t=await this.loadRoutesFromJsonFile(e);return this.routes=t,t}async loadRoutesFromJsonFile(e){try{const t=this,o=await fetch(e),n=(await o.json()).routes,r={},a=new MarkerService;if(n&&Array.isArray(n))return n.forEach((e=>{if(e.points&&Array.isArray(e.points)){a.createRouteMarkers(e);const o=a.routeMarkers[e.routeId],n=a.markerStyles;t.shapeStyles=t.createShapeStyles(e.shapeColor);const i=t.createRouteShape(e);r[e.routeId]={shape:i,markers:o,shapeStyles:t.shapeStyles,markerStyles:n,isSelected:!1,visible:!0,routedata:e}}})),t.markersService=a,r;console.error("Некорректный формат данных в JSON!")}catch(e){console.error("Ошибка загрузки маршрута:",e)}}init(e){console.log("Инициализация маршрута"),this.shapeStyles=e.shapeStyles;const t=e;t.shape=this.createRouteShape(e.routedata),this.currentRoute=t;const o=new MarkerService;o.init(e),this.markersService=o,this.routes={[e.routedata.routeId]:t},console.log("this.routes",this.routes)}createRouteShape(e){let t;const o=[],n=this.shapeStyles.defaultStyle;switch(e.points.forEach((e=>o.push(e.coordinates))),e.type){case"polyline":t=L.polyline(o,{...n,objId:e.routeId,name:e.routeName,address:e.address});break;case"polygon":t=L.polygon(o,{...n,objId:e.routeId,name:e.routeName,address:e.address})}return t}createShapeStyles(e){let t;return t={defaultStyle:{color:e||MapConstans.DEFAULT_SHAPE_COLOR,weight:5,opacity:.7,dashArray:"10, 10"},highlightStyle:{color:MapConstans.HIGHLIGHT_SHAPE_COLOR,weight:6,opacity:1,dashArray:null}},t}groupeRoutesByCity(){const e=this.routes,t={};for(const[o,n]of Object.entries(e)){const e=n.routedata.routeCity||"Неизвестный город";t[e]||(t[e]=[]),t[e].push({routeId:o,route:n})}return t}selectRoute(e){const t=this.routes[e];t&&(this.deselectRoute(),t.isSelected=!0,this.currentRoute=t,t.shape.setStyle(this.shapeStyles.highlightStyle))}deselectRoute(){this.currentRoute&&this.resetRoute(this.currentRoute)}resetRoute(e){this.currentRoute=null,e.isSelected=!1,e.shape.setStyle(e.shapeStyles.defaultStyle),e.shape.closePopup()}}class MarkerService{routeMarkers={};prevMarker;currentMarker;nextMarker;markerStyles;constructor(){this.setMarkerStyles()}createRouteMarkers(e){const t=this;let o=[],n={};const r=this.markerStyles;e.points.forEach(((a,i)=>{n={name:a.name,id:a.id,address:a.address,key:a.key,description:a.description,photoPaths:a.photoPaths,photoDescriptions:a.photoDescriptions,role:a.role,routeId:e.routeId};const s=t.getMarkerIcon(n),c=L.marker(a.coordinates,{routeId:e.routeId,index:i,activeIcon:MapConstans.DEFAULT_ACTIVE_MARKER_MENU_ICON,icon:s,markerData:n,markerStyles:r,isSelected:!1});o.push(c)})),this.routeMarkers[e.routeId]=o}init(e){console.log("Иницализация MarkerService"),console.log("route",e),this.markerStyles=e.markerStyles,this.createRouteMarkers(e.routedata)}selectMarker(e){const t=this.routeMarkers[e.options.routeId],o="start-end"===t.at(-1)?.options?.markerData?.role?t.at(-1):null;this.currentMarker!==e&&null!=this.currentMarker&&this.resetMarker(this.currentMarker),this.setPrevAndNextMarker(e),this.currentMarker=e;const n=this.markerStyles;e.options.isSelected=!0,"between"===e.options.markerData.role?e.setIcon(n.highlightDefaultMarker):"between-multimedia"===e.options.markerData.role?e.setIcon(n.highlightDefaultMultimediaMarker):(0===e.options.index&&null!=o&&o.setIcon(n.highlightMarker),e.setIcon(n.highlightMarker))}setPrevAndNextMarker(e){const t=e.options.index,o=this.routeMarkers[e.options.routeId];switch(e.options.markerData.role){case"start":this.prevMarker=null,this.nextMarker=o[t+1];break;case"end":this.prevMarker=o[t-1],this.nextMarker=null;break;case"start-end":t===o.length-1?(this.prevMarker=o[t-1],this.nextMarker=o[0]):(this.prevMarker=o[o.length-1],this.nextMarker=o[t+1]);break;default:this.prevMarker=o[t-1],this.nextMarker=o[t+1]}}deselectMarker(){this.currentMarker&&this.resetMarker(this.currentMarker)}resetMarker(e){this.currentMarker=null;const t=this.routeMarkers[e.options.routeId],o="start-end"===t.at(-1)?.options?.markerData?.role?t.at(-1):null;e.options.isSelected=!1,this.setMarkerIcon(e),0===e.options.index&&null!=o&&this.setMarkerIcon(o),e.closePopup()}setMarkerIcon(e){const t=e.options.markerData,o=this.markerStyles;switch(t.role){case"start":e.setIcon(o.startMarker);break;case"end":e.setIcon(o.endMarker);break;case"start-end":e.setIcon(o.startEndMarker);break;case"point":e.setIcon(o.pointMarker);break;case"between-multimedia":e.setIcon(o.defaultMiltimediaMarker);break;case"between":e.setIcon(o.defaultMarker)}}getMarkerActiveIconClassName(e){return e.options.markerData.activeIcon}setCurrentMarkerActiveIcon(e){marker.options.markerData.activeIcon=e}isMarkerDefault(e){return"Промежуточная точка"===e.name}setMarkerStyles(){const e=MapConstans.MARKER_POINTS_ICON_CLASSLIST,t=MapConstans.MARKER_BETWEEN_MULTIMEDIA_POINTS_ICON_CLASSLIST,o=MapConstans.MARKER_BETWEEN_POINTS_ICON_CLASSLIST,n=[6,26],r=[6,20],a=[10,23],i=[0,-200],s=L.divIcon({description:"Маркер точки начала маршрута",className:"default-boxicon-marker",html:`<i class='${e} map-start-route-marker'></i>`,iconAnchor:n,popupAnchor:i}),c=L.divIcon({description:"Маркер точки конца маршрута",className:"default-boxicon-marker",html:`<i class='${e} map-end-route-marker'></i>`,iconAnchor:n,popupAnchor:i}),l=L.divIcon({description:"Маркер точки начала и конца маршрута",className:"default-boxicon-marker",html:`<span class="icon-layer"><i class="${e} map-end-route-marker base"></i><i class="${e} map-end-route-markers top"></i></span>`,iconAnchor:n,popupAnchor:i}),p=L.divIcon({description:"Маркер точки маршрута",className:"default-boxicon-marker",html:`<i class='${e} map-point-marker'></i>`,iconAnchor:n,popupAnchor:i}),d=L.divIcon({description:"Маркер выбранной точки маршрута",className:"highlight-boxicon-marker",html:`<i class='${e} map-highlight-marker'></i>`,iconAnchor:n,popupAnchor:i}),u=L.divIcon({description:"Маркер промежуточной точки маршрута с мультимедиа файлами",className:"default-boxicon-marker",html:`<i class='${t} map-default-multimedia-marker'></i>`,iconAnchor:r,popupAnchor:i}),m=L.divIcon({description:"Маркер промежуточной точки маршрута с мультимедиа файлами",className:"highlight-boxicon-marker",html:`<i class='${t} map-highlight-default-multimedia-marker'></i>`,iconAnchor:r,popupAnchor:i}),h=L.divIcon({description:"Маркер промежуточной точки маршрута",className:"default-boxicon-marker",html:`<i class='${o} map-default-marker'></i>`,iconAnchor:a,popupAnchor:i}),g=L.divIcon({description:"Маркер выбранной промежуточной точки маршрута",className:"highlight-boxicon-marker",html:`<i class='${o} map-highlight-default-marker'></i>`,iconAnchor:a,popupAnchor:i});this.markerStyles={startMarker:s,endMarker:c,startEndMarker:l,pointMarker:p,highlightMarker:d,defaultMiltimediaMarker:u,highlightDefaultMultimediaMarker:m,defaultMarker:h,highlightDefaultMarker:g}}getMarkerIcon(e){let t=null;const o=this.markerStyles,n=o.startMarker,r=o.endMarker,a=o.startEndMarker,i=o.pointMarker,s=o.defaultMarker,c=o.defaultMiltimediaMarker;switch(e.role){case"start":t=n;break;case"end":t=r;break;case"start-end":t=a;break;case"point":t=i;break;case"between-multimedia":t=c;break;case"between":t=s}return t}isMarkerDefault(e){return"Промежуточная точка"===e.name}}export{handleMapNavigation};